<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>入浴予定表管理システム</title>
    <style>
        /* --- 1. Variables & Reset --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --danger: #dc2626;
            --success: #059669;
            --warning: #d97706;
            --bg-body: #f1f5f9;
            --bg-surface: #ffffff;
            --border: #cbd5e1;
            
            /* Palette matched to screenshots (Sharper Colors, Text Black) */
            --c-pink-bg: #ffe0e0; --c-pink-text: #000000;
            --c-blue-bg: #e3f2fd; --c-blue-text: #000000;
            --c-yellow-bg: #fff9c4; --c-yellow-text: #000000;
            --c-green-bg: #e8f5e9; --c-green-text: #000000;
            --c-purple-bg: #f3e5f5; --c-purple-text: #000000;
            --c-gray-bg: #f5f5f5; --c-gray-text: #000000;
            --c-white-bg: #ffffff; --c-white-text: #000000;
            --c-orange-bg: #ffe0b2; --c-orange-text: #000000;
        }

        * { box-sizing: border-box; }
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: var(--bg-body);
            color: #000; /* Darker base color */
            margin: 0;
            padding: 0;
            font-size: 14px;
        }

        button, input, select, textarea { font-family: inherit; }

        /* --- 2. Utility Classes (Tailwind-ish) --- */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .justify-end { justify-content: flex-end; }
        .gap-1 { gap: 4px; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .gap-4 { gap: 16px; }
        .gap-8 { gap: 32px; }
        .p-0 { padding: 0; }
        .p-1 { padding: 4px; }
        .p-2 { padding: 8px; }
        .p-3 { padding: 12px; }
        .p-4 { padding: 16px; }
        .px-2 { padding-left: 8px; padding-right: 8px; }
        .px-3 { padding-left: 12px; padding-right: 12px; }
        .px-4 { padding-left: 16px; padding-right: 16px; }
        .py-1 { padding-top: 4px; padding-bottom: 4px; }
        .py-2 { padding-top: 8px; padding-bottom: 8px; }
        .py-3 { padding-top: 12px; padding-bottom: 12px; }
        .m-0 { margin: 0; }
        .mt-auto { margin-top: auto; }
        .mt-0\.5 { margin-top: 2px; }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mb-1 { margin-bottom: 4px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .mb-8 { margin-bottom: 32px; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .w-8 { width: 32px; }
        .h-8 { height: 32px; }
        .w-1-3 { width: 33.333%; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .font-bold { font-weight: 700; }
        .text-xs { font-size: 11px; }
        .text-sm { font-size: 12px; }
        .text-lg { font-size: 18px; }
        .text-xl { font-size: 20px; }
        .text-3xl { font-size: 32px; }
        .text-4xl { font-size: 42px; }
        .text-5xl { font-size: 48px; }
        .text-base { font-size: 16px; }
        .rounded { border-radius: 6px; }
        .rounded-full { border-radius: 9999px; }
        .rounded-lg { border-radius: 8px; }
        .border { border: 1px solid var(--border); }
        .border-b { border-bottom: 1px solid var(--border); }
        .bg-white { background-color: white; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-slate-50 { background-color: #f8fafc; }
        .hover\:bg-gray-100:hover { background-color: #f3f4f6; }
        .shadow { box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .hidden { display: none !important; }
        .cursor-pointer { cursor: pointer; }
        .overflow-hidden { overflow: hidden; }

        /* Text Colors - Added !important to ensure override on table headers */
        .text-red { color: #d32f2f !important; }
        .text-blue { color: #1976d2 !important; }
        .text-gray { color: #424242; }
        .text-gray-400 { color: #94a3b8; }
        .text-gray-500 { color: #64748b; }
        .text-gray-600 { color: #475569; }
        .text-gray-700 { color: #334155; }
        .text-gray-800 { color: #1f2937; }
        .text-red-600 { color: #dc2626; }
        .text-red-700 { color: #b91c1c; }
        .text-red-800 { color: #991b1b; }
        .text-red-900 { color: #7f1d1d; }
        .text-blue-500 { color: #3b82f6; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-700 { color: #1d4ed8; }
        .text-blue-900 { color: #1e3a8a; }
        .text-orange-500 { color: #f97316; }
        .text-white { color: white; }

        .border-gray-200 { border-color: #e2e8f0; }

        /* --- 3. Component Styles --- */
        
        /* Header */
        header {
            background-color: #1e293b;
            color: white;
            padding: 12px 20px;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            background: white;
            color: #334155;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn:hover { background-color: #f8fafc; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: #b91c1c; }

        .btn-icon { padding: 6px; border-radius: 6px; }
        .btn-dark { background-color: #334155; color: white; border: 1px solid #475569; }
        .btn-dark:hover { background-color: #475569; }

        /* Calendar Grid */
        .container {
            max-width: 1200px; /* A4-ish optimized width */
            margin: 20px auto;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            padding: 40px;
            min-height: 297mm; /* A4 height */
        }

        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #000; /* Sharp black border */
            table-layout: fixed; /* レイアウト崩れ防止：列幅を固定 */
        }

        .calendar-table th, .calendar-table td {
            border: 1px solid #000; /* Sharp black border */
        }

        .calendar-table th {
            background-color: #fff;
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #000;
            width: 14.28%; /* 7 columns */
            font-size: 16px;
            color: #000; /* Default color is black */
            font-weight: bold;
        }
        
        .calendar-table td {
            padding: 0;
            vertical-align: top;
            border-left: 1px solid #000;
            border-right: 1px solid #000;
            height: 1px; /* Required to make child height:100% work for equal height rows */
        }

        /* 
           Calendar Row Layout Implementation (3 TRs per week)
           This ensures that slots align horizontally across the week
        */
        .cal-row-1 td { 
            border-top: 1px solid #000; 
            border-bottom: 1px dashed #333; 
            vertical-align: top; 
        }
        .cal-row-2 td { 
            border-top: none; /* Let previous dashed border show */
            border-bottom: 1px dashed #333; 
            vertical-align: top; 
        }
        .cal-row-3 td { 
            border-top: none;
            border-bottom: 1px solid #000; 
            vertical-align: bottom; /* Bottom alignment for the last slot */
        }

        /* 
           Layout for cell internals 
           Using flex to stretch content to full height of TD
        */
        .cell-inner {
            height: 100%;
            min-height: 100%;
            display: flex;
            flex-direction: column;
        }

        .date-label {
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            height: 28px;
            line-height: 28px;
            margin: 0;
            padding: 0;
            color: #000;
            border-bottom: 1px solid #000; /* Separator between date and slot 1 */
            flex: 0 0 28px;
        }
        .date-label.is-sunday { color: #d32f2f; }
        .date-label.is-saturday { color: #1976d2; }

        .slot {
            display: flex;
            flex-direction: column; /* 改行(div等)が縦に並ぶように修正 */
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 4px;
            font-size: 13px; /* 指示に基づき大きく調整 (11px -> 13px) */
            line-height: 1.25;
            cursor: pointer;
            transition: opacity 0.1s;
            white-space: pre-wrap;
            word-break: break-all;
            color: #000;
            width: 100%;
            /* Make slot fill the available space */
            flex-grow: 1;
        }
        
        .slot:hover { opacity: 0.8; box-shadow: inset 0 0 100px rgba(0,0,0,0.05); }

        .week-footer-row td {
            padding: 0;
            height: 28px; /* 指示に基づき中央揃えしやすく調整 */
            border: 1px solid #000 !important; /* 確実に一周するように境界線を固定 */
        }
        
        .week-footer-cell {
            display: flex;
            flex-direction: column; /* 改行(div等)が縦に並ぶように修正 */
            align-items: center;
            justify-content: center; /* 水平・垂直方向ともに中央揃え */
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            padding: 4px;
            cursor: pointer;
            height: 100%;
            width: 100%; /* colspanされたTD一杯に広がる */
        }

        /* Color Classes */
        .bg-pink { background-color: var(--c-pink-bg); color: var(--c-pink-text); }
        .bg-blue { background-color: var(--c-blue-bg); color: var(--c-blue-text); }
        .bg-yellow { background-color: var(--c-yellow-bg); color: var(--c-yellow-text); }
        .bg-green { background-color: var(--c-green-bg); color: var(--c-green-text); }
        .bg-purple { background-color: var(--c-purple-bg); color: var(--c-purple-text); }
        .bg-gray { background-color: var(--c-gray-bg); color: var(--c-gray-text); }
        .bg-white { background-color: var(--c-white-bg); color: var(--c-white-text); }
        .bg-orange { background-color: var(--c-orange-bg); color: var(--c-orange-text); }

        /* Rich Editor Styles */
        .rich-editor-box {
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .rich-editor-toolbar {
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            padding: 6px 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .rich-editor-toolbar span {
            font-size: 10px;
            color: #64748b;
            font-weight: bold;
            margin-right: 2px;
        }
        .rich-tool-btn {
            width: 22px;
            height: 22px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
            cursor: pointer;
            display: inline-block;
            transition: transform 0.1s;
        }
        .rich-tool-btn:hover { transform: scale(1.1); z-index: 10; }
        .rich-tool-btn.color-black { background-color: #000000; }
        .rich-tool-btn.color-red { background-color: #dc2626; }
        .rich-tool-btn.color-blue { background-color: #2563eb; }

        .rich-editor-content {
            padding: 8px 12px;
            min-height: 80px;
            max-height: 200px;
            font-size: 14px;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap;
            color: #000;
        }
        .rich-editor-content:focus {
            background-color: #fff;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }

        /* Input Styling */
        input[type="text"], input[type="date"], select, textarea {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            width: 100%;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--c-blue-bg);
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(2px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            transition: transform 0.2s;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }

        .modal-lg { max-width: 1100px; height: 90vh; }
        
        .modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-body {
            padding: 16px 24px;
            overflow-y: auto;
            flex: 1;
        }
        .modal-body.p-0 {
            padding: 0;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f8fafc;
            border-radius: 0 0 12px 12px;
        }

        /* --- New Design Styles for Config Modal --- */
        .modal-header.dark-theme {
            background-color: #1e293b;
            color: white;
            border-bottom: 1px solid #334155;
            padding: 16px 24px;
        }
        .modal-header.dark-theme h3 {
            color: white;
        }
        .modal-header.dark-theme .btn-icon {
            color: #94a3b8;
        }
        .modal-header.dark-theme .btn-icon:hover {
            background-color: #334155;
            color: white;
        }

        .config-section-box {
            background-color: #eff6ff; /* blue-50 */
            border: 1px solid #dbeafe; /* blue-100 */
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #1e3a8a; /* blue-900 */
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        /* Week Cards */
        .week-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
        }
        .week-card {
            background: white;
            border: 1px solid #bfdbfe; /* blue-200 */
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .week-label {
            color: #2563eb; /* blue-600 */
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 8px;
        }
        
        /* Master Config Grid (New Layout) */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            align-items: start;
        }
        .config-card {
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .config-slot-group {
            border-bottom: 1px dashed #e2e8f0;
            padding-bottom: 16px;
            margin-bottom: 4px;
        }
        .config-slot-group:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }
        .config-slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .config-slot-label {
            font-size: 11px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Color Selection Dots */
        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 0 1px #cbd5e1;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .color-dot:hover {
            transform: scale(1.15);
            z-index: 2;
        }
        .color-dot.selected {
            box-shadow: 0 0 0 2px #334155;
            transform: scale(1.15);
            z-index: 1;
        }

        /* Resident Chips */
        .resident-chip-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }
        .resident-chip {
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 8px 12px;
            display: inline-flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            font-weight: 500;
            color: #334155;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            min-width: 120px;
        }
        .resident-delete-btn {
            color: #cbd5e1;
            cursor: pointer;
            margin-left: 8px;
            padding: 2px;
            display: flex;
            align-items: center;
        }
        .resident-delete-btn:hover {
            color: #ef4444; /* red-500 */
        }

        .add-resident-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .add-resident-input {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            width: 320px;
            font-size: 14px;
        }
        .add-resident-input::placeholder {
            color: #94a3b8;
        }
        .add-resident-btn {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            width: 42px;
            height: 42px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 20px;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
        }
        .add-resident-btn:hover {
            background-color: #4338ca;
        }

        /* Master Grid Select */
        .master-slot-select {
            font-size: 10px;
            padding: 2px 6px;
            background-color: white;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            color: #475569;
            cursor: pointer;
            max-width: 110px;
            height: 24px;
        }
        .master-slot-select:hover {
            border-color: #94a3b8;
        }

        /* --- Print Styles --- */
        @media print {
            @page { 
                size: A4 portrait; 
                margin: 4mm; 
            }
            
            html, body {
                height: 100vh;
                width: 100%;
                margin: 0; 
                padding: 0;
                overflow: hidden;
            }
            
            body {
                background: white; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                display: flex;
                flex-direction: column;
            }
            
            /* Hide non-printable elements */
            header, .no-print, .btn, .modal-overlay, .rich-editor-toolbar { 
                display: none !important; 
            }

            #app {
                width: 100%;
                height: 100vh;
                display: flex;
                flex-direction: column;
            }
            
            .container { 
                width: 100%; 
                max-width: none; 
                height: 100vh !important;
                min-height: auto !important;
                margin: 0; 
                padding: 3mm !important; 
                box-shadow: none;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            /* Adjust Header area in Print - Maintain the stable Grid */
            .container > .relative.mb-8.pt-6 {
                flex: 0 0 auto;
                margin-bottom: 2mm !important;
                padding-top: 0 !important;
            }

            .container > .relative.mb-8.pt-6 > div:first-child {
                display: grid !important;
                grid-template-columns: 1fr auto 1fr !important;
                align-items: end !important;
                justify-items: center !important;
                width: 100% !important;
                border-bottom: 2px solid #000 !important;
                padding-bottom: 1mm !important;
                position: relative !important;
                gap: 0 !important;
            }

            #facilityName {
                grid-column: 1 !important;
                font-size: 26px !important;
                width: 100% !important;
                text-align: right !important;
                margin-right: 10px !important;
                border: none !important;
                padding: 0 !important;
            }

            #calendarTitleSuffix {
                grid-column: 2 !important;
                font-size: 26px !important;
                white-space: nowrap !important;
                margin: 0 4mm !important;
            }
            
            .absolute.right-0.bottom-3 {
                grid-column: 3 !important;
                position: static !important;
                justify-self: end !important;
                display: flex !important;
                align-items: baseline !important;
                width: auto !important;
                writing-mode: horizontal-tb !important;
            }
            
            .absolute.right-0.bottom-3 input {
                font-size: 18px !important;
                width: 75px !important;
                text-align: right !important;
                font-weight: bold !important;
                border: none !important;
            }
            
            .absolute.right-0.bottom-3 span {
                font-size: 16px !important;
                font-weight: bold !important;
                display: inline-block !important;
            }

            /* Calendar Root takes remaining space */
            #calendarRoot {
                flex: 1 1 auto;
                display: flex;
                flex-direction: column;
                height: 0;
                overflow: hidden;
            }

            /* Table stretches to fill root but stays in page */
            .calendar-table { 
                width: 100%;
                height: 100%;
                border: 2px solid #000; 
                border-collapse: collapse;
                table-layout: fixed;
            }

            .calendar-table th {
                height: 22px !important;
                font-size: 14px !important;
                padding: 1px !important;
            }
            
            .calendar-table td {
                height: auto !important;
            }

            .date-label {
                height: 20px !important;
                line-height: 20px !important;
                font-size: 14px !important;
            }

            .slot {
                font-size: 12px !important;
                padding: 2px !important;
                line-height: 1.15 !important;
            }

            .week-footer-cell {
                height: 24px !important;
                padding: 0 !important;
                font-size: 12px !important;
            }
            
            .rich-editor-content { white-space: pre-wrap; }
        }
    </style>
</head>
<body>

<div id="app">
    <!-- Header -->
    <header>
        <div style="max-width: 1200px; margin: 0 auto;" class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-blue-600 rounded text-white" style="background: var(--primary);">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                </div>
                <div>
                    <h1 class="font-bold text-lg m-0">入浴予定表管理</h1>
                    <div class="text-xs opacity-75">Bathing Schedule Manager</div>
                </div>
            </div>

            <div class="flex items-center gap-2 flex-wrap justify-center">
                <!-- Undo/Redo -->
                <div class="flex items-center bg-slate-700 rounded p-1 gap-1" style="background: #334155;">
                    <button id="btnUndo" class="btn btn-dark btn-icon" title="戻る">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>
                    </button>
                    <button id="btnRedo" class="btn btn-dark btn-icon" title="進む">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 7v6h-6"></path><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 3.7"></path></svg>
                    </button>
                </div>

                <!-- Month Nav -->
                <div class="flex items-center bg-white rounded shadow px-2 py-1">
                    <button id="btnPrevMonth" class="btn-icon hover:bg-gray-100 rounded">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                    </button>
                    <span id="currentMonthLabel" class="font-bold text-lg px-4" style="font-feature-settings: 'tnum';">2026年 2月</span>
                    <button id="btnNextMonth" class="btn-icon hover:bg-gray-100 rounded">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                    </button>
                </div>

                <div style="width: 1px; height: 24px; background: #475569; margin: 0 8px;"></div>

                <button id="btnCheck" class="btn" style="background: #fff7ed; color: #9a3412; border: 1px solid #fed7aa;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    回数確認
                </button>
                <button id="btnConfig" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    マスタ設定
                </button>
                <button id="btnPrint" class="btn btn-success">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                    印刷
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Calendar Header -->
        <div class="relative mb-8 pt-6">
            <div class="flex justify-center items-end gap-8 pb-3 border-b-2 border-slate-800 mx-auto relative" style="max-width: 96%; border-bottom-width: 3px;">
                <input type="text" id="facilityName" value="2 階 東 棟" 
                       class="font-bold text-right bg-transparent border-none focus:ring-0 text-slate-800 placeholder-slate-300" 
                       style="width: 400px; outline: none; font-family: inherit; line-height: 1.2; font-size: 42px; padding: 0;">
                <span id="calendarTitleSuffix" class="font-bold text-slate-800 text-4xl" style="font-feature-settings: 'palt'; line-height: 1.2; white-space: nowrap;">月間予定表 (令和8年 2月)</span>
                
                <div class="absolute right-0 bottom-3">
                    <div class="flex items-center gap-1 text-red font-bold text-sm">
                        <input type="text" id="updateDateInput" 
                               class="bg-transparent border-none p-1 text-right font-bold text-red placeholder-red-300 focus:ring-0 cursor-pointer hover:bg-red-50 rounded transition" 
                               style="width: 80px; font-size: 24px; outline: none; font-family: inherit;"
                               aria-label="更新日">
                        <span style="font-size: 20px;">更新</span>
                        <label for="updateDateInput" class="cursor-pointer">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Table -->
        <div id="calendarRoot"></div>
    </main>

    <!-- Modals -->
    <!-- 1. Edit Slot Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="font-bold m-0 flex items-center gap-2">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                    内容編集
                </h3>
                <button class="modal-close btn-icon hover:bg-gray-200">✕</button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">名簿から追加</label>
                    <select id="editResidentSelect" class="w-full">
                        <option value="">選択してください...</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">内容</label>
                    <div id="editRichEditorContainer"></div>
                    <div class="text-xs text-gray-400 mt-1 text-right">※改行、文字色設定が可能です</div>
                </div>

                <div class="mb-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">背景色</label>
                    <div id="editColorPicker" class="flex gap-3 justify-center"></div>
                </div>

                <div id="weekPropagateOption" class="hidden mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="propagateCheck">
                        <span class="text-sm font-bold text-yellow-800">今後の同週設定（デフォルト）として保存</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-close btn btn-dark">キャンセル</button>
                <button id="btnSaveEdit" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>

    <!-- 2. Master Config Modal -->
    <div id="configModal" class="modal-overlay">
        <div class="modal-content modal-lg">
            <div class="modal-header dark-theme">
                <div>
                    <h3 class="font-bold m-0 flex items-center gap-2 text-white">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        マスタ設定・名簿管理
                    </h3>
                    <div class="text-xs text-slate-400" style="margin-top: 4px;">基本パターンの登録と入所者名簿の編集を行います</div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex border border-slate-600 rounded">
                        <button class="btn-icon p-1 hover:bg-slate-700 text-slate-400" title="元に戻す"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg></button>
                        <div style="width:1px; background:#475569;"></div>
                        <button class="btn-icon p-1 hover:bg-slate-700 text-slate-400" title="やり直す"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 14l5-5-5-5"/><path d="M20 9H9.5A5.5 5.5 0 0 0 4 14.5v0A5.5 5.5 0 0 0 9.5 20H13"/></svg></button>
                    </div>
                    <button class="modal-close btn-icon text-white hover:bg-slate-700">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            </div>
            
            <div class="modal-body" style="background-color: #ffffff;">
                <section class="config-section-box">
                    <h4 class="section-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                        週番号ごとのデフォルト設定 (マスタ)
                    </h4>
                    <div id="configWeeklyFooterRoot" class="week-card-grid"></div>
                </section>

                <section class="config-section-box">
                    <h4 class="section-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        入所者名簿
                    </h4>
                    <div id="configResidentList" class="resident-chip-list"></div>
                    <div class="add-resident-container">
                        <input type="text" id="newResidentInput" placeholder="新しい名前を入力..." class="add-resident-input">
                        <button id="btnAddResident" class="add-resident-btn" title="追加">＋</button>
                    </div>
                </section>

                <section class="config-section-box" style="margin-bottom: 0;">
                    <div style="border-left: 4px solid #1e293b; padding-left: 12px; margin-bottom: 12px;">
                        <h4 class="font-bold text-sm text-gray-800 m-0">曜日固定パターン</h4>
                    </div>
                    <div id="configMasterGrid" class="config-grid"></div>
                </section>

                <div class="mt-8 pt-4 border-t flex justify-between items-center">
                    <div class="text-xs text-gray-500">データのバックアップ・復元</div>
                    <div class="flex gap-2">
                        <button id="btnExportJson" class="btn text-xs">JSON書き出し</button>
                        <button id="btnImportJson" class="btn text-xs">JSON読み込み</button>
                        <input type="file" id="fileImport" class="hidden" accept=".json">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-close btn" style="border: 1px solid #cbd5e1; color: #334155;">破棄して閉じる</button>
                <button id="btnSaveConfig" class="btn btn-primary" style="padding: 10px 24px; font-weight: bold;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 21 17 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    設定を保存
                </button>
            </div>
        </div>
    </div>

    <!-- 3. Check Result Modal -->
    <div id="checkModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #fff; border-bottom: 1px solid #e2e8f0;">
                <h3 class="font-bold m-0 text-gray-800">入浴回数確認結果</h3>
                <button class="modal-close btn-icon hover:bg-gray-100 text-gray-600">✕</button>
            </div>
            <div class="modal-body p-0">
                <div id="checkResultBody"></div>
            </div>
        </div>
    </div>

    <!-- 4. Confirm Import Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="background-color: #fff; border-bottom: 1px solid #e2e8f0;">
                <h3 class="font-bold m-0 text-gray-800">確認</h3>
                <button class="modal-close btn-icon hover:bg-gray-100 text-gray-600">✕</button>
            </div>
            <div class="modal-body text-center p-6">
                <p class="text-lg font-bold mb-2">読み込みますか？</p>
                <p class="text-sm text-gray-500">現在のデータは上書きされます。</p>
            </div>
            <div class="modal-footer justify-center gap-4 bg-gray-50 rounded-b-lg">
                <button id="btnConfirmNo" class="btn btn-dark w-1-2 justify-center">いいえ</button>
                <button id="btnConfirmYes" class="btn btn-primary w-1-2 justify-center">はい</button>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * Bathing Schedule Application (Vanilla JS)
 */

// --- Constants & Config ---
const COLORS = [
    { key: 'pink',   label: 'ピンク', bg: 'bg-pink' },
    { key: 'blue',   label: '青',    bg: 'bg-blue' },
    { key: 'yellow', label: '黄',    bg: 'bg-yellow' },
    { key: 'green',  label: '緑',    bg: 'bg-green' },
    { key: 'purple', label: '紫',    bg: 'bg-purple' },
    { key: 'white',  label: '白',    bg: 'bg-white' },
    { key: 'gray',   label: '灰',    bg: 'bg-gray' },
    { key: 'orange', label: '橙',    bg: 'bg-orange' },
];

const INITIAL_RESIDENTS = [
  '駒田守彦', '窪山裕子', '水谷藤子', '山田三枝子',
  '吉田すえ', '田中淑子', '家木洋子', '松本美好',
  '中村弘', '増田久雄', '西', '太田', '星合', '谷口', '紀平'
];

const INITIAL_MASTER = {
    0: { slot1: { t: '駒田守彦\n窪山裕子\n2東寺嶋', c: 'pink' }, slot2: { t: '水谷藤子\n山田三枝子', c: 'gray' }, slot3: { t: '', c: 'white' } },
    1: { slot1: { t: '吉田すえ\n田中淑子\n西 太田', c: 'pink' }, slot2: { t: '家木洋子\n西①星合\n谷口', c: 'pink' }, slot3: { t: '訪問販売', c: 'white' } },
    2: { slot1: { t: '中村弘\n増田久雄', c: 'gray' }, slot2: { t: 'リハビリ\n清掃\n(24Hシート)', c: 'yellow' }, slot3: { t: '', c: 'white' } },
    3: { slot1: { t: '駒田守彦\n窪山裕子\n2東寺嶋', c: 'pink' }, slot2: { t: '松本美好\n西 紀平', c: 'pink' }, slot3: { t: 'ヒロタ', c: 'white' } },
    4: { slot1: { t: '水谷藤子\n山田三枝子', c: 'gray' }, slot2: { t: '家木洋子\n西①星合\n谷口', c: 'pink' }, slot3: { t: '', c: 'white' } },
    5: { slot1: { t: 'リハビリ\n吉田すえ\n田中淑子', c: 'pink' }, slot2: { t: 'シーツ交換', c: 'yellow' }, slot3: { t: '回診', c: 'white' } },
    6: { slot1: { t: '松本美好\n西 紀平', c: 'pink' }, slot2: { t: '中村弘\n増田久雄', c: 'gray' }, slot3: { t: '精神科', c: 'white' } }
};
const INITIAL_WEEKLY_FOOTERS = [
    { t: '衛生チェック(樋谷)', c: 'yellow' },
    { t: '衛生チェック( )', c: 'yellow' },
    { t: '衛生チェック( )', c: 'yellow' },
    { t: '衛生チェック( )', c: 'yellow' },
    { t: '衛生チェック( )', c: 'yellow' }
];

class App {
    constructor() {
        const today = new Date();
        const defaultUpdateDate = `${today.getMonth() + 1}/${today.getDate()}`;
        
        const safeParse = (key, fallback) => {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : fallback;
            } catch (e) {
                return fallback;
            }
        };

        this.state = {
            date: today,
            facilityName: localStorage.getItem('v3_facility') || '2 階 東 棟',
            updateDate: localStorage.getItem('v3_update_date') || defaultUpdateDate,
            master: safeParse('v3_master', INITIAL_MASTER),
            weeklyDefaults: safeParse('v3_weekly_defs', INITIAL_WEEKLY_FOOTERS),
            overrides: safeParse('v3_overrides', {}),
            weeklyOverrides: safeParse('v3_weekly_overrides', {}),
            residents: safeParse('v3_residents', INITIAL_RESIDENTS)
        };
        
        this.history = [];
        this.historyPtr = -1;
        this.pushHistory();

        this.editing = null; 
        this.pendingImportFile = null;

        this.init();
    }

    init() {
        this.bindEvents();
        this.render();
    }

    pushHistory() {
        const snapshot = JSON.stringify({
            master: this.state.master,
            weeklyDefaults: this.state.weeklyDefaults,
            overrides: this.state.overrides,
            weeklyOverrides: this.state.weeklyOverrides,
            residents: this.state.residents
        });
        
        if (this.historyPtr < this.history.length - 1) {
            this.history = this.history.slice(0, this.historyPtr + 1);
        }
        
        if (this.history.length > 0 && this.history[this.historyPtr] === snapshot) return;

        this.history.push(snapshot);
        if(this.history.length > 20) this.history.shift();
        else this.historyPtr++;
        
        this.updateUndoRedoUI();
    }

    undo() {
        if(this.historyPtr > 0) {
            this.historyPtr--;
            this.restoreHistory();
        }
    }

    redo() {
        if(this.historyPtr < this.history.length - 1) {
            this.historyPtr++;
            this.restoreHistory();
        }
    }

    restoreHistory() {
        const data = JSON.parse(this.history[this.historyPtr]);
        this.state.master = data.master;
        this.state.weeklyDefaults = data.weeklyDefaults;
        this.state.overrides = data.overrides;
        this.state.weeklyOverrides = data.weeklyOverrides;
        this.state.residents = data.residents;
        this.saveLocally(false);
        this.render();
        this.updateUndoRedoUI();
    }

    updateUndoRedoUI() {
        const undo = document.getElementById('btnUndo');
        const redo = document.getElementById('btnRedo');
        if (undo) {
            undo.disabled = this.historyPtr <= 0;
            undo.style.opacity = undo.disabled ? 0.5 : 1;
        }
        if (redo) {
            redo.disabled = this.historyPtr >= this.history.length - 1;
            redo.style.opacity = redo.disabled ? 0.5 : 1;
        }
    }

    saveLocally(pushHist = true) {
        localStorage.setItem('v3_facility', this.state.facilityName);
        localStorage.setItem('v3_update_date', this.state.updateDate);
        localStorage.setItem('v3_master', JSON.stringify(this.state.master));
        localStorage.setItem('v3_weekly_defs', JSON.stringify(this.state.weeklyDefaults));
        localStorage.setItem('v3_overrides', JSON.stringify(this.state.overrides));
        localStorage.setItem('v3_weekly_overrides', JSON.stringify(this.state.weeklyOverrides));
        localStorage.setItem('v3_residents', JSON.stringify(this.state.residents));
        if(pushHist) this.pushHistory();
    }

    render() {
        const d = this.state.date;
        const currentMonthLabel = document.getElementById('currentMonthLabel');
        const calendarTitleSuffix = document.getElementById('calendarTitleSuffix');
        const facilityNameInput = document.getElementById('facilityName');
        const updateDateInput = document.getElementById('updateDateInput');

        if (currentMonthLabel) currentMonthLabel.textContent = `${d.getFullYear()}年 ${d.getMonth()+1}月`;
        if (calendarTitleSuffix) calendarTitleSuffix.textContent = `月間予定表 (令和${d.getFullYear()-2018}年 ${d.getMonth()+1}月)`;
        if (facilityNameInput) facilityNameInput.value = this.state.facilityName;
        if (updateDateInput) updateDateInput.value = this.state.updateDate;

        this.renderCalendar();
    }

    renderCalendar() {
        const root = document.getElementById('calendarRoot');
        if (!root) return;

        const year = this.state.date.getFullYear();
        const month = this.state.date.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startDay = new Date(year, month, 1).getDay();
        
        let html = '<table class="calendar-table"><thead><tr>';
        ['日','月','火','水','木','金','土'].forEach((day, i) => {
            const colorClass = i === 0 ? 'text-red' : i === 6 ? 'text-blue' : '';
            html += `<th class="${colorClass}">${day}曜日</th>`;
        });
        html += '</tr></thead><tbody>';

        let currentDay = 1;
        for (let row = 0; row < 6; row++) {
             const weekData = [];
             let hasActualDate = false;

             for (let col = 0; col < 7; col++) {
                 const isBeforeStart = (row === 0 && col < startDay);
                 const isAfterEnd = (currentDay > daysInMonth);
                 if (isBeforeStart || isAfterEnd) {
                     weekData.push(null);
                 } else {
                     weekData.push(currentDay);
                     currentDay++;
                     hasActualDate = true;
                 }
             }

             if (!hasActualDate && row > 0) break;

             html += '<tr class="cal-row-1">';
             weekData.forEach((dayNum, colIdx) => {
                 if (dayNum === null) {
                     html += '<td style="background:#f8fafc;"></td>';
                 } else {
                     const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`;
                     const master = this.state.master[colIdx];
                     const ov = this.state.overrides[dateKey] || {};
                     const data = ov.slot1 || master.slot1;
                     const dateClass = colIdx === 0 ? 'is-sunday' : colIdx === 6 ? 'is-saturday' : '';
                     html += `<td><div class="cell-inner">
                        <div class="date-label ${dateClass}">${dayNum}</div>
                        <div class="slot ${this.getColorClass(data.c)}" onclick="app.openEdit('day', '${dateKey}', 'slot1', ${row})">${this.formatContent(data.t)}</div>
                     </div></td>`;
                 }
             });
             html += '</tr><tr class="cal-row-2">';
             weekData.forEach((dayNum, colIdx) => {
                 if (dayNum === null) {
                     html += '<td style="background:#f8fafc;"></td>';
                 } else {
                     const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`;
                     const master = this.state.master[colIdx];
                     const ov = this.state.overrides[dateKey] || {};
                     const data = ov.slot2 || master.slot2;
                     html += `<td><div class="cell-inner">
                        <div class="slot ${this.getColorClass(data.c)}" onclick="app.openEdit('day', '${dateKey}', 'slot2', ${row})">${this.formatContent(data.t)}</div>
                     </div></td>`;
                 }
             });
             html += '</tr><tr class="cal-row-3">';
             weekData.forEach((dayNum, colIdx) => {
                 if (dayNum === null) {
                     html += '<td style="background:#f8fafc;"></td>';
                 } else {
                     const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`;
                     const master = this.state.master[colIdx];
                     const ov = this.state.overrides[dateKey] || {};
                     const data = ov.slot3 || master.slot3;
                     html += `<td><div class="cell-inner">
                        <div class="slot ${this.getColorClass(data.c)} font-bold" onclick="app.openEdit('day', '${dateKey}', 'slot3', ${row})">${this.formatContent(data.t)}</div>
                     </div></td>`;
                 }
             });
             html += '</tr>';
             
             if (hasActualDate) {
                 const weekKey = `${year}-${month+1}-W${row}`;
                 const defaultFooter = this.state.weeklyDefaults[Math.min(row, 4)] || { t: '', c: 'white' };
                 const footerData = this.state.weeklyOverrides[weekKey] || defaultFooter;
                 html += `<tr class="week-footer-row">
                    <td colspan="7" onclick="app.openEdit('week', '${weekKey}', null, ${row})">
                        <div class="week-footer-cell ${this.getColorClass(footerData.c)}">
                            ${this.formatContent(footerData.t)}
                        </div>
                    </td>
                 </tr>`;
             }
        }
        html += '</tbody></table>';
        root.innerHTML = html;
    }

    renderConfigModal() {
        const footerRoot = document.getElementById('configWeeklyFooterRoot');
        if (footerRoot) {
            footerRoot.innerHTML = '';
            this.state.weeklyDefaults.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'week-card';
                div.innerHTML = `
                    <div class="week-label">第${idx+1}週目</div>
                    ${this.renderRichEditor(`footer-editor-${idx}`, item.t, `app.updateConfigFooter(${idx}, 't', this.innerHTML)`)}
                    <div id="footer-dots-${idx}" class="flex justify-center gap-2 mt-auto pt-2">
                        ${this.renderColorPicker(item.c, (c) => `app.selectConfigFooterColor(${idx}, '${c}')`)}
                    </div>
                `;
                const editor = div.querySelector('.rich-editor-content');
                if (editor) editor.classList.add(this.getColorClass(item.c));
                footerRoot.appendChild(div);
            });
        }

        const resRoot = document.getElementById('configResidentList');
        if (resRoot) {
            resRoot.innerHTML = '';
            this.state.residents.forEach(name => {
                const tag = document.createElement('div');
                tag.className = 'resident-chip';
                tag.innerHTML = `
                    <span>${this.escape(name)}</span>
                    <span class="resident-delete-btn" onclick="app.removeResident('${name}')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </span>
                `;
                resRoot.appendChild(tag);
            });
        }

        const masterRoot = document.getElementById('configMasterGrid');
        if (masterRoot) {
            masterRoot.innerHTML = '';
            const residentOptions = this.state.residents.map(r => `<option value="${r}">${r}</option>`).join('');
            ['日','月','火','水','木','金','土'].forEach((dayName, idx) => {
                const dayData = this.state.master[idx];
                const card = document.createElement('div');
                card.className = 'config-card';
                const headerColor = idx === 0 ? 'text-red-600' : idx === 6 ? 'text-blue-600' : 'text-gray-800';
                let cardHtml = `<div class="text-center pb-3 border-b border-gray-100 mb-2"><span class="font-bold text-lg ${headerColor}">${dayName}曜日</span></div>`;
                ['slot1', 'slot2', 'slot3'].forEach((slotKey, slotIdx) => {
                    const sData = dayData[slotKey];
                    const label = slotIdx === 0 ? '上段' : slotIdx === 1 ? '中段' : '下段';
                    cardHtml += `
                        <div class="config-slot-group">
                            <div class="config-slot-header">
                                <span class="config-slot-label">${label}</span>
                                <select class="master-slot-select" onchange="app.appendResidentToMaster(${idx}, '${slotKey}', this)">
                                    <option value="">+ 名簿から追加</option>
                                    ${residentOptions}
                                </select>
                            </div>
                            <div class="mb-3">
                                ${this.renderRichEditor(`master-editor-${idx}-${slotKey}`, sData.t, `app.updateConfigMaster(${idx}, '${slotKey}', 't', this.innerHTML)`)}
                            </div>
                            <div id="master-dots-${idx}-${slotKey}" class="flex justify-center gap-2">
                                ${this.renderColorPicker(sData.c, (c) => `app.selectConfigMasterColor(${idx}, '${slotKey}', '${c}')`)}
                            </div>
                        </div>
                    `;
                });
                card.innerHTML = cardHtml;
                masterRoot.appendChild(card);
                ['slot1', 'slot2', 'slot3'].forEach((slotKey) => {
                    const sData = dayData[slotKey];
                    const editor = card.querySelector(`#master-editor-${idx}-${slotKey} .rich-editor-content`);
                    if(editor) editor.classList.add(this.getColorClass(sData.c));
                });
            });
        }
    }

    changeMonth(delta) {
        const d = this.state.date;
        this.state.date = new Date(d.getFullYear(), d.getMonth() + delta, 1);
        this.render();
    }

    openEdit(type, key, slot, weekIdx) {
        this.editing = { type, key, slot, weekIdx };
        const modal = document.getElementById('editModal');
        const editorContainer = document.getElementById('editRichEditorContainer');
        const colorPicker = document.getElementById('editColorPicker');
        const residentSelect = document.getElementById('editResidentSelect');
        const propagateDiv = document.getElementById('weekPropagateOption');
        if (!modal || !editorContainer || !colorPicker || !residentSelect) return;
        
        let currentData;
        if (type === 'day') {
            const [y, m, d] = key.split('-').map(Number);
            const dateObj = new Date(y, m - 1, d);
            const dayOfWeek = dateObj.getDay();
            const ov = this.state.overrides[key] || {};
            currentData = ov[slot] ? ov[slot] : this.state.master[dayOfWeek][slot];
            if (propagateDiv) propagateDiv.classList.add('hidden');
        } else {
            const ov = this.state.weeklyOverrides[key];
            currentData = ov ? ov : this.state.weeklyDefaults[Math.min(weekIdx, 4)];
            if (propagateDiv) {
                propagateDiv.classList.remove('hidden');
                document.getElementById('propagateCheck').checked = false;
            }
        }

        editorContainer.innerHTML = this.renderRichEditor('editMainEditor', currentData.t, '');
        const editorContent = editorContainer.querySelector('.rich-editor-content');
        if(editorContent) editorContent.classList.add(this.getColorClass(currentData.c));

        colorPicker.innerHTML = COLORS.map(c => `
            <div class="color-dot ${c.bg} ${c.key === currentData.c ? 'selected' : ''}" 
                 onclick="app.selectEditColor(this, '${c.key}')" 
                 title="${c.label}"></div>
        `).join('');
        this.editing.tempColor = currentData.c;

        residentSelect.innerHTML = '<option value="">名簿から追加...</option>';
        this.state.residents.forEach(r => {
            residentSelect.innerHTML += `<option value="${r}">${r}</option>`;
        });

        modal.classList.add('active');
    }

    selectEditColor(el, color) {
        document.querySelectorAll('#editColorPicker .color-dot').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        this.editing.tempColor = color;
        const editorContent = document.querySelector('#editMainEditor .rich-editor-content');
        if(editorContent) {
            COLORS.forEach(c => editorContent.classList.remove(c.bg));
            editorContent.classList.add(this.getColorClass(color));
        }
    }

    saveEdit() {
        if(!this.editing) return;
        const editorContent = document.querySelector('#editMainEditor .rich-editor-content');
        const text = editorContent ? editorContent.innerHTML : '';
        const color = this.editing.tempColor;
        const { type, key, slot, weekIdx } = this.editing;
        if (type === 'day') {
            if(!this.state.overrides[key]) this.state.overrides[key] = {};
            this.state.overrides[key][slot] = { t: text, c: color };
        } else {
            this.state.weeklyOverrides[key] = { t: text, c: color };
            if(document.getElementById('propagateCheck').checked) {
                if(weekIdx < 5) this.state.weeklyDefaults[weekIdx] = { t: text, c: color };
            }
        }
        this.saveLocally();
        this.render();
        this.closeModal('editModal');
    }

    updateConfigFooter(idx, field, val) { this.state.weeklyDefaults[idx][field] = val; }
    updateConfigMaster(dayIdx, slot, field, val) { this.state.master[dayIdx][slot][field] = val; }

    selectConfigMasterColor(dayIdx, slotKey, color) {
        this.state.master[dayIdx][slotKey].c = color;
        const editor = document.querySelector(`#master-editor-${dayIdx}-${slotKey} .rich-editor-content`);
        if(editor) {
            COLORS.forEach(c => editor.classList.remove(c.bg));
            editor.classList.add(this.getColorClass(color));
        }
        const container = document.getElementById(`master-dots-${dayIdx}-${slotKey}`);
        if(container) {
            Array.from(container.children).forEach(dot => dot.classList.remove('selected'));
            const targetDot = container.querySelector(`[data-color="${color}"]`);
            if(targetDot) targetDot.classList.add('selected');
        }
    }

    selectConfigFooterColor(idx, color) {
        this.state.weeklyDefaults[idx].c = color;
        const editor = document.querySelector(`#footer-editor-${idx} .rich-editor-content`);
        if(editor) {
            COLORS.forEach(c => editor.classList.remove(c.bg));
            editor.classList.add(this.getColorClass(color));
        }
        const container = document.getElementById(`footer-dots-${idx}`);
        if(container) {
            Array.from(container.children).forEach(dot => dot.classList.remove('selected'));
            const targetDot = container.querySelector(`[data-color="${color}"]`);
            if(targetDot) targetDot.classList.add('selected');
        }
    }
    
    appendResidentToMaster(dayIdx, slotKey, selectEl) {
        const val = selectEl.value;
        if(!val) return;
        const editorId = `master-editor-${dayIdx}-${slotKey}`;
        const editor = document.querySelector(`#${editorId} .rich-editor-content`);
        if(editor) {
            const hasContent = editor.innerText.trim().length > 0;
            const appendHtml = (hasContent ? '<br>' : '') + val;
            editor.insertAdjacentHTML('beforeend', appendHtml);
            this.state.master[dayIdx][slotKey].t = editor.innerHTML;
        }
        selectEl.value = '';
    }

    addResident() {
        const input = document.getElementById('newResidentInput');
        const val = input.value.trim();
        if(val && !this.state.residents.includes(val)) {
            this.state.residents.push(val);
            input.value = '';
            this.renderConfigModal(); 
        }
    }
    removeResident(name) {
        this.state.residents = this.state.residents.filter(r => r !== name);
        this.renderConfigModal();
    }
    saveConfig() {
        const year = this.state.date.getFullYear();
        const month = this.state.date.getMonth();
        for(let row=0; row<6; row++) {
            const weekKey = `${year}-${month+1}-W${row}`;
            if (this.state.weeklyOverrides[weekKey]) delete this.state.weeklyOverrides[weekKey];
        }
        this.saveLocally();
        this.render();
        this.closeModal('configModal');
    }

    async exportJson() {
        const stateStr = JSON.stringify(this.state, null, 2);
        
        // ファイル名生成: yyyy-mm-dd HH:mm:ss入浴スケジュール.json
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const hh = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        const ss = String(now.getSeconds()).padStart(2, '0');
        const fileName = `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}入浴スケジュール.json`;

        // Modern browsers with File System Access API
        if ('showSaveFilePicker' in window) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'JSON File',
                        accept: { 'application/json': ['.json'] },
                    }],
                });
                const writable = await handle.createWritable();
                await writable.write(stateStr);
                await writable.close();
            } catch (err) {
                // User cancelled or other error
                if (err.name !== 'AbortError') {
                    console.error('Save failed:', err);
                    alert('保存に失敗しました。');
                }
            }
        } else {
            // Fallback for older browsers (no location picker)
            const blob = new Blob([stateStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
            alert('保存場所を選択できませんでした。ダウンロードフォルダを確認してください。');
        }
    }

    importJson(e) {
        const file = e.target.files[0];
        if(!file) return;
        e.target.value = '';
        this.pendingImportFile = file;
        const confirmModal = document.getElementById('confirmModal');
        if (confirmModal) confirmModal.classList.add('active');
    }
    
    executeImport() {
        const file = this.pendingImportFile;
        this.pendingImportFile = null;
        const confirmModal = document.getElementById('confirmModal');
        if (confirmModal) confirmModal.classList.remove('active');
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const data = JSON.parse(ev.target.result);
                if(data.master && data.residents) {
                    this.state = { ...this.state, ...data };
                    this.state.date = new Date(this.state.date);
                    if(isNaN(this.state.date.getTime())) this.state.date = new Date();
                    this.saveLocally();
                    this.render();
                    this.renderConfigModal();
                    alert('設定を読み込みました');
                } else {
                    alert('データ形式が正しくありません');
                }
            } catch(err) {
                alert('エラー: ' + err.message);
            }
        };
        reader.readAsText(file);
    }

    runCheck() {
        const year = this.state.date.getFullYear();
        const month = this.state.date.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const firstDayObj = new Date(year, month, 1);
        const startDay = firstDayObj.getDay();
        const weeks = [];
        let currentDay = 1;
        for (let row = 0; row < 6; row++) {
             if (currentDay > daysInMonth) break;
             const weekStartDay = currentDay;
             let daysInThisWeek = row === 0 ? 7 - startDay : 7;
             const weekEndDay = Math.min(weekStartDay + daysInThisWeek - 1, daysInMonth);
             const counts = {};
             this.state.residents.forEach(r => counts[r] = 0);
             weeks.push({ id: row, start: weekStartDay, end: weekEndDay, counts });
             currentDay = weekEndDay + 1;
        }
        for(let d=1; d<=daysInMonth; d++) {
            const dateObj = new Date(year, month, d);
            const dateKey = this.formatDate(dateObj);
            const dayOfWeek = dateObj.getDay();
            let weekIdx = 0;
            if (d <= (7 - startDay)) { weekIdx = 0; }
            else { weekIdx = Math.floor((d - (7 - startDay) - 1) / 7) + 1; }
            if (!weeks[weekIdx]) continue;
            const master = this.state.master[dayOfWeek];
            const ov = this.state.overrides[dateKey] || {};
            const txt = [ov.slot1?.t || master.slot1.t, ov.slot2?.t || master.slot2.t, ov.slot3?.t || master.slot3.t].join(' ');
            this.state.residents.forEach(r => {
                if(txt.includes(r)) weeks[weekIdx].counts[r]++;
            });
        }
        const body = document.getElementById('checkResultBody');
        if (!body) return;
        let html = `<div class="p-4 bg-gray-100" style="min-height: 400px; max-height: 70vh; overflow-y: auto;"><div class="bg-white border border-gray-200 text-gray-800 p-4 rounded-lg mb-6 text-sm flex items-start gap-3 shadow-sm"><div class="text-gray-400 mt-0.5"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></div><div><div class="font-bold mb-1">入浴回数確認結果 (2回未満=赤, 3回以上=青)</div></div></div>`;
        let hasIssues = false;
        weeks.forEach((week, i) => {
            const issues = [];
            this.state.residents.forEach(r => {
                const c = week.counts[r];
                if (c < 2) issues.push({ name: r, count: c, type: 'low' });
                else if (c >= 3) issues.push({ name: r, count: c, type: 'high' });
            });
            if (issues.length === 0) return;
            hasIssues = true;
            html += `<div class="mb-6"><h4 class="text-center text-blue-600 font-bold text-base mb-3">第${i+1}週 (${month+1}/${week.start}〜${week.end})</h4><div class="flex flex-col gap-2">`;
            issues.forEach(item => {
                 const textColor = item.type === 'low' ? 'text-red-600' : 'text-blue-600';
                 html += `<div class="flex items-center justify-between bg-white border border-gray-200 rounded-lg px-4 py-3 shadow-sm"><span class="font-bold text-lg ${textColor}">${item.name}</span><span class="font-bold text-gray-600 bg-gray-50 border border-gray-200 px-3 py-1 rounded text-sm">${item.count}回</span></div>`;
            });
            html += `</div></div>`;
        });
        if (!hasIssues) html += `<div class="text-center py-12 text-gray-400"><div class="text-5xl mb-4">🎉</div><div class="font-bold text-lg">問題ありません</div></div>`;
        html += `</div>`;
        body.innerHTML = html;
        const checkModal = document.getElementById('checkModal');
        if (checkModal) checkModal.classList.add('active');
    }

    bindEvents() {
        const btnPrevMonth = document.getElementById('btnPrevMonth');
        const btnNextMonth = document.getElementById('btnNextMonth');
        const btnUndo = document.getElementById('btnUndo');
        const btnRedo = document.getElementById('btnRedo');
        const btnConfig = document.getElementById('btnConfig');
        const btnCheck = document.getElementById('btnCheck');
        const btnPrint = document.getElementById('btnPrint');
        const btnSaveEdit = document.getElementById('btnSaveEdit');
        const btnSaveConfig = document.getElementById('btnSaveConfig');
        const editResidentSelect = document.getElementById('editResidentSelect');
        const facilityName = document.getElementById('facilityName');
        const updateDateInput = document.getElementById('updateDateInput');
        const btnAddResident = document.getElementById('btnAddResident');
        const btnExportJson = document.getElementById('btnExportJson');
        const btnImportJson = document.getElementById('btnImportJson');
        const fileImport = document.getElementById('fileImport');
        const btnConfirmYes = document.getElementById('btnConfirmYes');
        const btnConfirmNo = document.getElementById('btnConfirmNo');

        if (btnPrevMonth) btnPrevMonth.onclick = () => this.changeMonth(-1);
        if (btnNextMonth) btnNextMonth.onclick = () => this.changeMonth(1);
        if (btnUndo) btnUndo.onclick = () => this.undo();
        if (btnRedo) btnRedo.onclick = () => this.redo();
        if (btnConfig) btnConfig.onclick = () => { this.renderConfigModal(); document.getElementById('configModal').classList.add('active'); };
        if (btnCheck) btnCheck.onclick = () => this.runCheck();
        if (btnPrint) btnPrint.onclick = () => window.print();
        if (btnSaveEdit) btnSaveEdit.onclick = () => this.saveEdit();
        if (btnSaveConfig) btnSaveConfig.onclick = () => this.saveConfig();
        if (btnAddResident) btnAddResident.onclick = () => this.addResident();
        if (btnExportJson) btnExportJson.onclick = () => this.exportJson();
        if (btnImportJson) btnImportJson.onclick = () => fileImport.click();
        if (fileImport) fileImport.onchange = (e) => this.importJson(e);
        if (btnConfirmYes) btnConfirmYes.onclick = () => this.executeImport();
        if (btnConfirmNo) btnConfirmNo.onclick = () => { this.pendingImportFile = null; document.getElementById('confirmModal').classList.remove('active'); };
        
        document.querySelectorAll('.modal-close').forEach(el => {
            el.onclick = (e) => this.closeModal(e.target.closest('.modal-overlay').id);
        });

        if (editResidentSelect) {
            editResidentSelect.onchange = (e) => {
                if(e.target.value) {
                    const editor = document.querySelector('#editMainEditor .rich-editor-content');
                    if(editor) {
                        editor.innerHTML = editor.innerHTML + (editor.innerHTML ? '<br>' : '') + e.target.value;
                        e.target.value = '';
                    }
                }
            };
        }
        if (facilityName) facilityName.onchange = (e) => { this.state.facilityName = e.target.value; this.saveLocally(); };
        if (updateDateInput) updateDateInput.onchange = (e) => { this.state.updateDate = e.target.value; this.saveLocally(); };
    }

    closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) modal.classList.remove('active');
        this.editing = null;
    }

    formatDate(d) {
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }

    getColorClass(key) { return COLORS.find(c => c.key === key)?.bg || 'bg-white'; }

    escape(str) { return str ? str.replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''; }

    renderRichEditor(id, initialValue, onInputStr) {
        let safeHtml = this.formatContent(initialValue);
        return `<div id="${id}" class="rich-editor-box"><div class="rich-editor-toolbar"><span>文字色:</span><button class="rich-tool-btn color-black" onmousedown="event.preventDefault(); app.execColor('removeFormat')" title="黒"></button><button class="rich-tool-btn color-red" onmousedown="event.preventDefault(); app.execColor('foreColor', '#dc2626')" title="赤"></button><button class="rich-tool-btn color-blue" onmousedown="event.preventDefault(); app.execColor('foreColor', '#2563eb')" title="青"></button></div><div class="rich-editor-content" contenteditable="true" oninput="${onInputStr}">${safeHtml}</div></div>`;
    }

    execColor(cmd, val) { document.execCommand(cmd, false, val); }

    formatContent(val) {
        if (!val) return '';
        let str = String(val);
        // HTMLタグ（<br> or <div> or <span> or <font or <p）が含まれているかチェック
        const hasTags = /<(br|div|span|font|p)/i.test(str);
        
        if (!hasTags) {
            // タグがない（プレーンテキスト）場合は、エスケープした上で \n を <br> に変換
            return this.escape(str).replace(/\n/g, '<br>');
        }
        
        // すでにタグがある場合はHTMLとして扱うが、
        // contenteditableで挿入された literalな改行文字(\n)も<br>に変換して確実に反映させる
        return str.replace(/\n/g, '<br>');
    }

    renderColorPicker(currentVal, clickHandlerStrGen) {
        return COLORS.map(c => `<div class="color-dot ${c.bg} ${c.key === currentVal ? 'selected' : ''}" data-color="${c.key}" onclick="${clickHandlerStrGen(c.key)}" title="${c.label}"></div>`).join('');
    }
}
const app = new App();
window.app = app;
</script>
</body>
</html>--- END OF FILE index.html ---
